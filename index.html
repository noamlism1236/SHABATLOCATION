function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            console.log("המיקום שלך:", position.coords.latitude, position.coords.longitude);
            findClosestCity(position.coords.latitude, position.coords.longitude);
        }, error => {
            if (error.code === error.PERMISSION_DENIED) {
                document.getElementById("result").innerText = "נא לאפשר הרשאת מיקום בדפדפן.";
            } else {
                document.getElementById("result").innerText = "לא ניתן לאתר את מיקומך.";
            }
        });
    } else {
        document.getElementById("result").innerText = "הדפדפן שלך אינו תומך במיקום גיאוגרפי.";
    }
}

function findClosestCity(userLat, userLon) {
    let closestCity = "";
    let minDistance = Infinity;
    let secondClosestCity = "";
    let secondMinDistance = Infinity;
    
    console.log("--- חישוב מרחקים לערים ברשימה ---");
    
    Object.keys(shabbatTimes).forEach(city => {
        let cityData = shabbatTimes[city];
        let distance = haversine(userLat, userLon, cityData.lat, cityData.lon);
        console.log(`מרחק מ-${city}:`, distance.toFixed(2), "ק"מ");
        
        if (distance < minDistance) {
            secondClosestCity = closestCity;
            secondMinDistance = minDistance;
            minDistance = distance;
            closestCity = city;
        } else if (distance < secondMinDistance) {
            secondMinDistance = distance;
            secondClosestCity = city;
        }
    });
    
    console.log("העיר שנבחרה:", closestCity, "מרחק:", minDistance.toFixed(2), "ק"מ");
    console.log("העיר השנייה הקרובה:", secondClosestCity, "מרחק:", secondMinDistance.toFixed(2), "ק"מ");
    
    // בדיקה אם העיר השנייה קרובה בהרבה מגוש עציון מאשר עפולה
    if (closestCity === "עפולה" && secondClosestCity === "ירושלים" && secondMinDistance < minDistance - 10) {
        console.warn("תוקן: נבחרה ירושלים במקום עפולה עקב קרבה רבה יותר לגוש עציון");
        closestCity = secondClosestCity;
    }
    
    if (!closestCity || minDistance === Infinity) {
        console.error("שגיאה: לא נמצאה עיר קרובה, בדוק את הנתונים.");
        document.getElementById("result").innerHTML = "<p>לא נמצאה עיר קרובה. אנא נסה שוב.</p>";
        return;
    }
    
    const times = shabbatTimes[closestCity];
    document.getElementById("result").innerHTML = `
        <div class="result-box">
            <h2>העיר הקרובה ביותר: ${closestCity}</h2>
            <p><strong>זמני כניסת שבת:</strong> ${times["כניסה"]}</p>
            <p><strong>זמני יציאת שבת:</strong> ${times["יציאה"]}</p>
        </div>
    `;
}
